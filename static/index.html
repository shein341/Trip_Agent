<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="AI é©±åŠ¨çš„æ™ºèƒ½æ—…è¡Œè§„åˆ’åŠ©æ‰‹">
  <title>âœˆï¸ æ™ºèƒ½æ—…è¡Œè§„åˆ’å¸ˆ | AI Travel Planner</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
  <!-- Chart.js for pie chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <!-- åŠ¨æ€èƒŒæ™¯ -->
  <div class="bg-animation"></div>

  <main class="container">
    <!-- æ ‡é¢˜ -->
    <header class="header">
      <h1>âœˆï¸ æ™ºèƒ½æ—…è¡Œè§„åˆ’å¸ˆ</h1>
      <p>å‘Šè¯‰æˆ‘æ‚¨çš„é¢„ç®—å’Œç›®çš„åœ°ï¼ŒAI ä¸ºæ‚¨å®šåˆ¶å®Œç¾è¡Œç¨‹</p>
      <button class="btn btn-history" id="history-toggle-btn">
        <span>ğŸ“š</span> å†å²è®°å½•
      </button>
    </header>

    <!-- å†å²è®°å½•ä¾§è¾¹æ  -->
    <aside class="history-sidebar" id="history-sidebar">
      <div class="sidebar-header">
        <h3>ğŸ“š å†å²è®°å½•</h3>
        <button class="sidebar-close" id="sidebar-close">âœ•</button>
      </div>
      <div class="history-list" id="history-list">
        <p class="history-empty">æš‚æ— å†å²è®°å½•</p>
      </div>
    </aside>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- è¾“å…¥è¡¨å• -->
    <section class="glass-card" id="form-section">
      <form id="travel-form">
        <!-- é¢„ç®— -->
        <div class="form-group full-width">
          <label>
            <span class="icon">ğŸ’°</span> æ—…è¡Œé¢„ç®—
          </label>
          <div class="budget-display">
            <span class="budget-value" id="budget-display">5000</span>
            <span class="budget-unit">å…ƒ</span>
          </div>
          <input type="range" id="budget" name="budget" class="budget-slider" min="1000" max="50000" step="500"
            value="5000">
        </div>

        <div class="form-grid">
          <!-- å‡ºå‘åœ° -->
          <div class="form-group">
            <label>
              <span class="icon">ğŸ </span> å‡ºå‘åœ°
            </label>
            <input type="text" id="departure" name="departure" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·..." required>
          </div>

          <!-- ç›®çš„åœ° -->
          <div class="form-group">
            <label>
              <span class="icon">ğŸ“</span> ç›®çš„åœ°
            </label>
            <input type="text" id="destination" name="destination" placeholder="ä¾‹å¦‚ï¼šæ­å·ã€ä¸‰äºšã€æˆéƒ½..." required>
          </div>

          <!-- å¼€å§‹æ—¥æœŸ -->
          <div class="form-group">
            <label>
              <span class="icon">ğŸ“…</span> å‡ºå‘æ—¥æœŸ
            </label>
            <input type="date" id="start-date" name="start_date" required>
          </div>

          <!-- ç»“æŸæ—¥æœŸ -->
          <div class="form-group">
            <label>
              <span class="icon">ğŸ</span> è¿”ç¨‹æ—¥æœŸ
            </label>
            <input type="date" id="end-date" name="end_date" required>
          </div>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div class="error-message" id="error-message"></div>

        <!-- æäº¤æŒ‰é’® -->
        <div class="form-group full-width" style="margin-top: 1.5rem;">
          <button type="submit" class="btn btn-primary" id="submit-btn">
            <span class="btn-icon">ğŸš€</span>
            <span>ç”Ÿæˆæ—…è¡Œè§„åˆ’</span>
          </button>
        </div>
      </form>
    </section>

    <!-- åŠ è½½çŠ¶æ€ - å¢å¼ºç‰ˆ -->
    <section class="glass-card loading-container" id="loading-section">
      <!-- é£æœºç»•åœ°çƒåŠ¨ç”» - å¯ç‚¹å‡»è§£å‹ -->
      <div class="orbit-loader">
        <div class="orbit-globe" id="clickable-globe" title="ç‚¹å‡»åœ°çƒè§£å‹ï¼">ğŸŒ</div>
        <div class="orbit-plane">âœˆï¸</div>
        <div class="orbit-ring"></div>
        <!-- ç‚¹å‡»è®¡æ•°å™¨ -->
        <div class="click-counter" id="click-counter">
          <span class="counter-value" id="counter-value">0</span>
          <span class="counter-label">æ¬¡ç‚¹å‡»</span>
        </div>
        <!-- ç‚¹å‡»ç‰¹æ•ˆå®¹å™¨ -->
        <div class="click-effects" id="click-effects"></div>
      </div>

      <!-- æ­¥éª¤è¿›åº¦ - åŒ…å«å†…å®¹å®¡æ ¸ -->
      <div class="loading-steps">
        <div class="step active" id="step-1">
          <div class="step-dot"></div>
          <span>ğŸ” è°ƒç ”</span>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step-2">
          <div class="step-dot"></div>
          <span>ğŸ“‹ æ–¹æ¡ˆ</span>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step-3">
          <div class="step-dot"></div>
          <span>ğŸ’° é¢„ç®—</span>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step-4">
          <div class="step-dot"></div>
          <span>âœ¨ è¡Œç¨‹</span>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step-5">
          <div class="step-dot"></div>
          <span>ğŸ“ æ¶¦è‰²</span>
        </div>
      </div>

      <p class="loading-status" id="loading-status">AI æ­£åœ¨è°ƒç ”ç›®çš„åœ°ä¿¡æ¯...</p>
      <p class="loading-hint">ğŸ’¡ ç‚¹å‡»åœ°çƒè§£å‹å“¦~</p>
    </section>

    <!-- ç»“æœå±•ç¤º - å¢å¼ºç‰ˆ -->
    <section class="glass-card result-container" id="result-section">
      <div class="result-header">
        <h2>ğŸ‰ æ‚¨çš„ä¸“å±è¡Œç¨‹</h2>
        <button class="btn btn-new" id="new-plan-btn">
          <span>ğŸ“</span> é‡æ–°è§„åˆ’
        </button>
      </div>

      <!-- é¢„ç®—é¥¼çŠ¶å›¾ -->
      <div class="budget-chart-container">
        <div class="chart-wrapper">
          <canvas id="budget-chart"></canvas>
        </div>
        <div class="chart-legend" id="chart-legend"></div>
      </div>

      <!-- è¡Œç¨‹å†…å®¹ -->
      <div class="result-content" id="result-content"></div>

      <!-- AI å¯¹è¯ä¿®æ”¹åŒº -->
      <div class="chat-section">
        <h3>ğŸ’¬ æƒ³ä¿®æ”¹æ–¹æ¡ˆï¼Ÿå‘Šè¯‰ AI</h3>
        <div class="chat-input-wrapper">
          <input type="text" id="chat-input" placeholder="ä¾‹å¦‚ï¼šå¢åŠ ç¾é£Ÿä½“éªŒã€å‡å°‘è´­ç‰©æ—¶é—´ã€æ¢ä¸€å®¶é…’åº—..." class="chat-input">
          <button class="btn btn-chat" id="chat-send-btn">
            <span>å‘é€</span>
          </button>
        </div>
        <div class="chat-loading" id="chat-loading">
          <span class="chat-spinner"></span>
          <span>AI æ­£åœ¨ä¿®æ”¹æ–¹æ¡ˆ...</span>
        </div>
      </div>
    </section>
  </main>

  <script>
    // å…ƒç´ å¼•ç”¨
    const form = document.getElementById('travel-form');
    const formSection = document.getElementById('form-section');
    const loadingSection = document.getElementById('loading-section');
    const resultSection = document.getElementById('result-section');
    const resultContent = document.getElementById('result-content');
    const errorMessage = document.getElementById('error-message');
    const budgetSlider = document.getElementById('budget');
    const budgetDisplay = document.getElementById('budget-display');
    const newPlanBtn = document.getElementById('new-plan-btn');
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send-btn');
    const chatLoading = document.getElementById('chat-loading');
    const loadingStatus = document.getElementById('loading-status');

    // å½“å‰æ–¹æ¡ˆæ•°æ®
    let currentPlan = '';
    let currentBudget = 5000;
    let currentDestination = '';
    let budgetChart = null;

    // è®¾ç½®é»˜è®¤æ—¥æœŸ
    const today = new Date();
    const startDate = new Date(today);
    startDate.setDate(startDate.getDate() + 7);
    const endDate = new Date(today);
    endDate.setDate(endDate.getDate() + 10);

    document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
    document.getElementById('end-date').value = endDate.toISOString().split('T')[0];

    // é¢„ç®—æ»‘å—æ›´æ–°
    budgetSlider.addEventListener('input', (e) => {
      budgetDisplay.textContent = parseInt(e.target.value).toLocaleString();
    });

    // ========== ç‚¹å‡»åœ°çƒè§£å‹æ¸¸æˆ ==========
    let clickCount = 0;
    const clickableGlobe = document.getElementById('clickable-globe');
    const counterValue = document.getElementById('counter-value');
    const clickEffects = document.getElementById('click-effects');

    clickableGlobe.addEventListener('click', (e) => {
      clickCount++;
      counterValue.textContent = clickCount;

      // åœ°çƒç¼©æ”¾åŠ¨ç”»
      clickableGlobe.style.transform = 'scale(1.3)';
      setTimeout(() => {
        clickableGlobe.style.transform = 'scale(1)';
      }, 150);

      // åˆ›å»º +1 ç‰¹æ•ˆ
      const effect = document.createElement('div');
      effect.className = 'click-effect';
      effect.textContent = '+1';
      effect.style.left = `${Math.random() * 60 + 20}%`;
      clickEffects.appendChild(effect);

      // ç§»é™¤ç‰¹æ•ˆ
      setTimeout(() => effect.remove(), 1000);

      // æ¯10æ¬¡æ˜¾ç¤ºå½©è›‹
      if (clickCount % 10 === 0) {
        const emojis = ['ğŸ‰', 'â­', 'ğŸš€', 'ğŸ’«', 'âœ¨'];
        const emoji = emojis[Math.floor(Math.random() * emojis.length)];
        const bonus = document.createElement('div');
        bonus.className = 'click-effect bonus';
        bonus.textContent = emoji;
        bonus.style.left = '50%';
        clickEffects.appendChild(bonus);
        setTimeout(() => bonus.remove(), 1500);
      }
    });

    // ========== åŠ è½½æ­¥éª¤åŠ¨ç”» (5 æ­¥) ==========
    const loadingSteps = [
      { id: 'step-1', text: 'AI æ­£åœ¨è°ƒç ”ç›®çš„åœ°ä¿¡æ¯...', delay: 0 },
      { id: 'step-2', text: 'AI æ­£åœ¨åˆ¶å®šåˆæ­¥æ–¹æ¡ˆ...', delay: 6000 },
      { id: 'step-3', text: 'AI æ­£åœ¨è¿›è¡Œé¢„ç®—å®¡æ ¸...', delay: 12000 },
      { id: 'step-4', text: 'AI æ­£åœ¨ç”Ÿæˆè¯¦ç»†è¡Œç¨‹...', delay: 18000 },
      { id: 'step-5', text: 'AI æ­£åœ¨æ¶¦è‰²ä¼˜åŒ–æ–‡æ¡ˆ...', delay: 24000 }
    ];

    let stepTimeouts = [];

    function startLoadingAnimation() {
      // é‡ç½®ç‚¹å‡»è®¡æ•°
      clickCount = 0;
      counterValue.textContent = '0';

      // é‡ç½®æ‰€æœ‰æ­¥éª¤
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active', 'done'));
      document.getElementById('step-1').classList.add('active');
      loadingStatus.textContent = loadingSteps[0].text;

      // è®¾ç½®æ­¥éª¤åŠ¨ç”»
      loadingSteps.slice(1).forEach((step, index) => {
        const timeout = setTimeout(() => {
          document.getElementById(loadingSteps[index].id).classList.remove('active');
          document.getElementById(loadingSteps[index].id).classList.add('done');
          document.getElementById(step.id).classList.add('active');
          loadingStatus.textContent = step.text;
        }, step.delay);
        stepTimeouts.push(timeout);
      });
    }

    function stopLoadingAnimation() {
      stepTimeouts.forEach(t => clearTimeout(t));
      stepTimeouts = [];
    }

    // è¡¨å•æäº¤
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMessage.classList.remove('active');

      const data = {
        budget: parseInt(budgetSlider.value),
        departure: document.getElementById('departure').value.trim(),
        destination: document.getElementById('destination').value.trim(),
        start_date: document.getElementById('start-date').value,
        end_date: document.getElementById('end-date').value
      };

      currentBudget = data.budget;
      currentDestination = data.destination;

      if (new Date(data.end_date) <= new Date(data.start_date)) {
        showError('è¿”ç¨‹æ—¥æœŸå¿…é¡»æ™šäºå‡ºå‘æ—¥æœŸ');
        return;
      }

      formSection.style.display = 'none';
      loadingSection.classList.add('active');
      resultSection.classList.remove('active');
      resultContent.innerHTML = ''; // æ¸…ç©ºå†…å®¹å‡†å¤‡æµå¼æ˜¾ç¤º
      startLoadingAnimation();

      // ä½¿ç”¨ SSE æµå¼è¾“å‡º
      const params = new URLSearchParams({
        budget: data.budget,
        departure: data.departure,
        destination: data.destination,
        start_date: data.start_date,
        end_date: data.end_date
      });

      const eventSource = new EventSource(`/travel-plan-stream?${params}`);
      let streamContent = '';

      eventSource.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);

          if (msg.type === 'status') {
            // æ›´æ–°æ­¥éª¤è¿›åº¦
            stopLoadingAnimation();
            for (let i = 1; i <= 5; i++) {
              const stepEl = document.getElementById(`step-${i}`);
              stepEl.classList.remove('active', 'done');
              if (i < msg.step) stepEl.classList.add('done');
              else if (i === msg.step) stepEl.classList.add('active');
            }
            loadingStatus.textContent = msg.message;
          }
          else if (msg.type === 'chunk') {
            // æ‰“å­—æœºæ•ˆæœ - å®æ—¶æ˜¾ç¤ºå†…å®¹
            streamContent += msg.content;
            // åˆ‡æ¢åˆ°ç»“æœé¡µé¢æ˜¾ç¤º
            if (loadingSection.classList.contains('active')) {
              loadingSection.classList.remove('active');
              resultSection.classList.add('active');
            }
            resultContent.innerHTML = formatMarkdown(streamContent);
            // æ»šåŠ¨åˆ°åº•éƒ¨
            resultContent.scrollTop = resultContent.scrollHeight;
          }
          else if (msg.type === 'done') {
            currentPlan = msg.content;
          }
          else if (msg.type === 'budget') {
            renderBudgetChart(msg.breakdown);
          }
          else if (msg.type === 'saved') {
            console.log('Plan saved with ID:', msg.plan_id);
            loadHistory(); // åˆ·æ–°å†å²è®°å½•
            eventSource.close();
          }
        } catch (err) {
          console.error('SSE parse error:', err);
        }
      };

      eventSource.onerror = (error) => {
        console.error('SSE error:', error);
        eventSource.close();
        stopLoadingAnimation();
        loadingSection.classList.remove('active');
        formSection.style.display = 'block';
        showError('è¿æ¥ä¸­æ–­ï¼Œè¯·é‡è¯•');
      };
    });

    // å‰ç«¯é¢„ç®—åˆ†è§£ï¼ˆå¤‡ç”¨ï¼‰
    function extract_budget_breakdown(totalBudget) {
      return [
        { category: "ğŸš— äº¤é€š", amount: Math.round(totalBudget * 0.30), color: "#6366f1" },
        { category: "ğŸ¨ ä½å®¿", amount: Math.round(totalBudget * 0.35), color: "#8b5cf6" },
        { category: "ğŸœ é¤é¥®", amount: Math.round(totalBudget * 0.15), color: "#f472b6" },
        { category: "ğŸ« é—¨ç¥¨", amount: Math.round(totalBudget * 0.12), color: "#22d3ee" },
        { category: "ğŸ›ï¸ å…¶ä»–", amount: Math.round(totalBudget * 0.08), color: "#fbbf24" }
      ];
    }

    // é‡æ–°è§„åˆ’
    newPlanBtn.addEventListener('click', () => {
      resultSection.classList.remove('active');
      formSection.style.display = 'block';
      if (budgetChart) {
        budgetChart.destroy();
        budgetChart = null;
      }
    });

    // ========== å†å²è®°å½•åŠŸèƒ½ ==========
    const historySidebar = document.getElementById('history-sidebar');
    const historyList = document.getElementById('history-list');
    const historyToggleBtn = document.getElementById('history-toggle-btn');
    const sidebarClose = document.getElementById('sidebar-close');
    const sidebarOverlay = document.getElementById('sidebar-overlay');

    historyToggleBtn.addEventListener('click', () => {
      historySidebar.classList.add('open');
      sidebarOverlay.classList.add('active');
      loadHistory();
    });

    sidebarClose.addEventListener('click', closeHistorySidebar);
    sidebarOverlay.addEventListener('click', closeHistorySidebar);

    function closeHistorySidebar() {
      historySidebar.classList.remove('open');
      sidebarOverlay.classList.remove('active');
    }

    async function loadHistory() {
      try {
        const response = await fetch('/history?limit=20');
        const result = await response.json();

        if (result.success && result.history.length > 0) {
          historyList.innerHTML = result.history.map(record => `
            <div class="history-item" data-id="${record.id}">
              <div class="history-info">
                <span class="history-dest">ğŸ“ ${record.destination}</span>
                <span class="history-date">${record.start_date} ~ ${record.end_date}</span>
                <span class="history-budget">ğŸ’° ${record.budget.toLocaleString()} å…ƒ</span>
              </div>
              <div class="history-actions">
                <button class="btn-load" onclick="loadPlan(${record.id})">æŸ¥çœ‹</button>
                <button class="btn-delete" onclick="deletePlan(${record.id})">åˆ é™¤</button>
              </div>
            </div>
          `).join('');
        } else {
          historyList.innerHTML = '<p class="history-empty">æš‚æ— å†å²è®°å½•</p>';
        }
      } catch (error) {
        console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
      }
    }

    // å…¨å±€å‡½æ•°ï¼šåŠ è½½å†å²æ–¹æ¡ˆ
    window.loadPlan = async function (planId) {
      try {
        const response = await fetch(`/history/${planId}`);
        const result = await response.json();

        if (result.success) {
          const record = result.record;
          currentPlan = record.plan_content;
          currentBudget = record.budget;
          currentDestination = record.destination;

          resultContent.innerHTML = formatMarkdown(record.plan_content);
          renderBudgetChart(extract_budget_breakdown(record.budget));

          formSection.style.display = 'none';
          loadingSection.classList.remove('active');
          resultSection.classList.add('active');
          closeHistorySidebar();
        }
      } catch (error) {
        console.error('åŠ è½½æ–¹æ¡ˆå¤±è´¥:', error);
      }
    };

    // å…¨å±€å‡½æ•°ï¼šåˆ é™¤æ–¹æ¡ˆ
    window.deletePlan = async function (planId) {
      console.log('åˆ é™¤æ–¹æ¡ˆ ID:', planId);

      if (!window.confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
        console.log('ç”¨æˆ·å–æ¶ˆåˆ é™¤');
        return;
      }

      try {
        console.log('å‘é€åˆ é™¤è¯·æ±‚...');
        const response = await fetch(`/history/${planId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        console.log('å“åº”çŠ¶æ€:', response.status);
        const result = await response.json();
        console.log('åˆ é™¤ç»“æœ:', result);

        if (result.success) {
          alert('åˆ é™¤æˆåŠŸï¼');
          loadHistory(); // åˆ·æ–°åˆ—è¡¨
        } else {
          alert('åˆ é™¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('åˆ é™¤è¯·æ±‚å¤±è´¥: ' + error.message);
      }
    };

    // AI å¯¹è¯ä¿®æ”¹
    chatSendBtn.addEventListener('click', sendChatModify);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChatModify();
    });

    async function sendChatModify() {
      const message = chatInput.value.trim();
      if (!message) return;

      chatInput.disabled = true;
      chatSendBtn.disabled = true;
      chatLoading.classList.add('active');

      try {
        const response = await fetch('/chat-modify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            current_plan: currentPlan,
            user_message: message,
            budget: currentBudget,
            destination: currentDestination
          })
        });

        const result = await response.json();

        if (result.success) {
          currentPlan = result.modified_plan;
          resultContent.innerHTML = formatMarkdown(result.modified_plan);
          renderBudgetChart(result.budget_breakdown);
          chatInput.value = '';
        } else {
          alert('ä¿®æ”¹å¤±è´¥ï¼š' + (result.message || 'è¯·é‡è¯•'));
        }
      } catch (error) {
        alert('è¯·æ±‚å¤±è´¥ï¼š' + error.message);
      } finally {
        chatInput.disabled = false;
        chatSendBtn.disabled = false;
        chatLoading.classList.remove('active');
      }
    }

    // æ¸²æŸ“é¢„ç®—é¥¼å›¾
    function renderBudgetChart(breakdown) {
      const ctx = document.getElementById('budget-chart').getContext('2d');

      if (budgetChart) {
        budgetChart.destroy();
      }

      const labels = breakdown.map(b => b.category);
      const data = breakdown.map(b => b.amount);
      const colors = breakdown.map(b => b.color);

      budgetChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderColor: 'rgba(255, 255, 255, 0.1)',
            borderWidth: 2,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '65%',
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              padding: 12,
              displayColors: true,
              callbacks: {
                label: (ctx) => ` ${ctx.parsed.toLocaleString()} å…ƒ`
              }
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true
          }
        }
      });

      // æ¸²æŸ“å›¾ä¾‹
      const legendContainer = document.getElementById('chart-legend');
      legendContainer.innerHTML = breakdown.map(b => `
        <div class="legend-item">
          <span class="legend-color" style="background: ${b.color}"></span>
          <span class="legend-label">${b.category}</span>
          <span class="legend-value">${b.amount.toLocaleString()}å…ƒ</span>
        </div>
      `).join('');
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
      errorMessage.textContent = 'âŒ ' + message;
      errorMessage.classList.add('active');
    }

    // ========== å¢å¼º Markdown æ ¼å¼åŒ–ï¼ˆæ”¯æŒè¡¨æ ¼ï¼‰==========
    function formatMarkdown(text) {
      // å…ˆå¤„ç†è¡¨æ ¼
      text = formatTables(text);

      return text
        // æ ‡é¢˜
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        // ç²—ä½“
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        // åˆ—è¡¨é¡¹ç¾åŒ–
        .replace(/^- (.+)$/gm, '<div class="list-item">$1</div>')
        // æ¢è¡Œ
        .replace(/\n/g, '<br>');
    }

    // è¡¨æ ¼è½¬ HTML
    function formatTables(text) {
      const lines = text.split('\n');
      let result = [];
      let inTable = false;
      let tableRows = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();

        // æ£€æµ‹è¡¨æ ¼è¡Œï¼ˆä»¥ | å¼€å¤´å’Œç»“å°¾ï¼‰
        if (line.startsWith('|') && line.endsWith('|')) {
          // è·³è¿‡åˆ†éš”è¡Œ (|---|---|)
          if (line.match(/^\|[\s:-]+\|$/)) {
            continue;
          }

          if (!inTable) {
            inTable = true;
            tableRows = [];
          }

          // è§£æå•å…ƒæ ¼
          const cells = line.slice(1, -1).split('|').map(c => c.trim());
          tableRows.push(cells);
        } else {
          // ç»“æŸè¡¨æ ¼
          if (inTable) {
            result.push(renderTable(tableRows));
            inTable = false;
            tableRows = [];
          }
          result.push(line);
        }
      }

      // å¤„ç†æœ«å°¾çš„è¡¨æ ¼
      if (inTable) {
        result.push(renderTable(tableRows));
      }

      return result.join('\n');
    }

    // æ¸²æŸ“è¡¨æ ¼ä¸ºç¾è§‚çš„å¡ç‰‡
    function renderTable(rows) {
      if (rows.length === 0) return '';

      let html = '<div class="styled-table">';

      rows.forEach((row, index) => {
        const isHeader = index === 0;
        html += `<div class="table-row ${isHeader ? 'header-row' : ''}">`;
        row.forEach(cell => {
          html += `<div class="table-cell">${cell}</div>`;
        });
        html += '</div>';
      });

      html += '</div>';
      return html;
    }
  </script>
</body>

</html>